<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализ рекламных кампаний</title>
    <script src="https://art009bas.github.io/reestr/tailwind.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .analysis-card {
            transition: all 0.3s ease;
        }
        
        .analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .select-dropdown {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }
        
        .history-item {
            border-left: 4px solid #3b82f6;
            transition: all 0.2s;
        }
        
        .history-item:hover {
            background-color: #f9fafb;
        }
        
        .floating-btn {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        
        .floating-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .nav-active {
            background-color: #3b82f6;
            color: white;
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Шапка приложения -->
        <header class="mb-10">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-chart-bar text-blue-500 mr-3"></i>
                    Анализ рекламных кампаний
                </h1>
            </div>
            <p class="text-gray-500 mt-2">Анализ эффективности рекламных кампаний по неделям</p>
            
            <!-- Навигация -->
            <div class="mt-6 flex space-x-4">
                <a href="index.html" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                    <i class="fas fa-chart-line mr-2"></i>Конверсия
                </a>
                <a href="vat-calculator.html" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                    <i class="fas fa-percent mr-2"></i>НДС
                </a>
                <a href="campaign-analysis.html" class="px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors">
                    <i class="fas fa-chart-bar mr-2"></i>Анализ кампаний
                </a>
            </div>
        </header>
        
        <main>
            <!-- Форма анализа кампаний -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8 fade-in">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-analytics text-blue-500 mr-3"></i>
                        Анализ рекламной кампании
                    </h2>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-gray-700 mb-2">Название кампании</label>
                            <input type="text" id="campaign-name" placeholder="Название кампании" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Неделя</label>
                            <input type="week" id="campaign-week" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-gray-700 mb-2">Расход (₽)</label>
                            <input type="number" id="expenses-input" placeholder="0" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Количество лидов</label>
                            <input type="number" id="leads-input" placeholder="0" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-gray-700 mb-2">Процент хороших лидов (%)</label>
                            <input type="number" id="good-leads-percent" placeholder="0" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Количество продаж</label>
                            <input type="number" id="sales-input" placeholder="0" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 mb-2">Доход (₽)</label>
                        <input type="number" id="income-input" placeholder="0" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div class="flex justify-center mb-6">
                        <button id="calculate-btn" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center">
                            <i class="fas fa-calculator mr-2"></i> Анализировать
                        </button>
                    </div>
                    
                    <div id="result-container" class="hidden bg-blue-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-blue-800 mb-4 text-center">Результаты анализа</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="stat-card bg-white p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600 mb-1">Цена лида</p>
                                <p id="lead-price-result" class="text-xl font-semibold text-blue-600"></p>
                            </div>
                            <div class="stat-card bg-white p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600 mb-1">Конверсия в продажу</p>
                                <p id="conversion-rate-result" class="text-xl font-semibold text-blue-600"></p>
                            </div>
                            <div class="stat-card bg-white p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600 mb-1">Стоимость продажи</p>
                                <p id="sale-cost-result" class="text-xl font-semibold text-blue-600"></p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="stat-card bg-white p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600 mb-1">Прибыль</p>
                                <p id="profit-result" class="text-xl font-semibold text-green-600"></p>
                            </div>
                            <div class="stat-card bg-white p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600 mb-1">ROI</p>
                                <p id="roi-result" class="text-xl font-semibold text-green-600"></p>
                            </div>
                        </div>
                        
                        <div class="flex justify-center">
                            <button id="copy-result-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                <i class="fas fa-copy mr-2"></i> Копировать результат
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- История анализов -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden fade-in">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-history text-purple-500 mr-3"></i>
                            История анализов
                        </h2>
                        <button id="clear-history-btn" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">
                            <i class="fas fa-trash-alt mr-1"></i> Очистить историю
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div id="history-container">
                        <div class="text-center py-10 text-gray-400" id="no-history-message">
                            <i class="fas fa-clock text-4xl mb-3"></i>
                            <p>История анализов пуста</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="mt-16 text-center text-gray-500 text-sm pb-8">
            <p>© 2025 Анализ рекламных кампаний. Все права защищены.</p>
        </footer>
    </div>

    <script>
        // Состояние приложения
        const state = {
            analyses: []
        };
        
        // Элементы DOM
        const elements = {
            campaignName: document.getElementById('campaign-name'),
            campaignWeek: document.getElementById('campaign-week'),
            expensesInput: document.getElementById('expenses-input'),
            leadsInput: document.getElementById('leads-input'),
            goodLeadsPercent: document.getElementById('good-leads-percent'),
            salesInput: document.getElementById('sales-input'),
            incomeInput: document.getElementById('income-input'),
            calculateBtn: document.getElementById('calculate-btn'),
            resultContainer: document.getElementById('result-container'),
            leadPriceResult: document.getElementById('lead-price-result'),
            conversionRateResult: document.getElementById('conversion-rate-result'),
            saleCostResult: document.getElementById('sale-cost-result'),
            profitResult: document.getElementById('profit-result'),
            roiResult: document.getElementById('roi-result'),
            copyResultBtn: document.getElementById('copy-result-btn'),
            historyContainer: document.getElementById('history-container'),
            noHistoryMessage: document.getElementById('no-history-message'),
            clearHistoryBtn: document.getElementById('clear-history-btn')
        };
        
        // Инициализация приложения
        function init() {
            // Устанавливаем текущую неделю по умолчанию
            const currentDate = new Date();
            const year = currentDate.getFullYear();
            const week = getWeekNumber(currentDate);
            elements.campaignWeek.value = `${year}-W${week.toString().padStart(2, '0')}`;
            
            // Загружаем данные из localStorage
            loadData();
            
            // Обработчики событий
            setupEventListeners();
            
            // Рендерим историю
            renderHistory();
        }
        
        // Получение номера недели
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }
        
        // Загрузка данных из localStorage
        function loadData() {
            const savedData = localStorage.getItem('campaignAnalysis');
            if (savedData) {
                const data = JSON.parse(savedData);
                state.analyses = data.analyses || [];
            }
        }
        
        // Сохранение данных в localStorage
        function saveData() {
            const data = {
                analyses: state.analyses
            };
            localStorage.setItem('campaignAnalysis', JSON.stringify(data));
        }
        
        // Анализ кампании
        function analyzeCampaign() {
            const campaignName = elements.campaignName.value.trim();
            const campaignWeek = elements.campaignWeek.value;
            const expenses = parseFloat(elements.expensesInput.value);
            const leads = parseInt(elements.leadsInput.value);
            const goodLeadsPercent = parseFloat(elements.goodLeadsPercent.value);
            const sales = parseInt(elements.salesInput.value);
            const income = parseFloat(elements.incomeInput.value);
            
            // Валидация
            if (!campaignName) {
                alert('Пожалуйста, введите название кампании');
                return;
            }
            
            if (!campaignWeek) {
                alert('Пожалуйста, выберите неделю');
                return;
            }
            
            if (isNaN(expenses) || expenses <= 0) {
                alert('Пожалуйста, введите корректный расход');
                return;
            }
            
            if (isNaN(leads) || leads < 0) {
                alert('Пожалуйста, введите корректное количество лидов');
                return;
            }
            
            if (isNaN(goodLeadsPercent) || goodLeadsPercent < 0 || goodLeadsPercent > 100) {
                alert('Пожалуйста, введите корректный процент хороших лидов (0-100)');
                return;
            }
            
            if (isNaN(sales) || sales < 0) {
                alert('Пожалуйста, введите корректное количество продаж');
                return;
            }
            
            if (isNaN(income) || income < 0) {
                alert('Пожалуйста, введите корректный доход');
                return;
            }
            
            // Расчет показателей
            const leadPrice = expenses / leads;
            const conversionRate = (sales / leads) * 100;
            const saleCost = expenses / sales;
            const profit = income - expenses;
            const roi = (profit / expenses) * 100;
            
            // Форматирование результата
            const formatter = new Intl.NumberFormat('ru-RU', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            const percentFormatter = new Intl.NumberFormat('ru-RU', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            // Показываем результат
            elements.leadPriceResult.textContent = leads > 0 ? `${formatter.format(leadPrice)} ₽` : 'N/A';
            elements.conversionRateResult.textContent = leads > 0 ? `${percentFormatter.format(conversionRate)}%` : 'N/A';
            elements.saleCostResult.textContent = sales > 0 ? `${formatter.format(saleCost)} ₽` : 'N/A';
            elements.profitResult.textContent = `${formatter.format(profit)} ₽`;
            elements.roiResult.textContent = `${percentFormatter.format(roi)}%`;
            elements.resultContainer.classList.remove('hidden');
            
            // Сохраняем в историю
            const analysis = {
                id: Date.now(),
                date: new Date().toISOString(),
                campaignName: campaignName,
                campaignWeek: campaignWeek,
                expenses: expenses,
                leads: leads,
                goodLeadsPercent: goodLeadsPercent,
                sales: sales,
                income: income,
                leadPrice: leadPrice,
                conversionRate: conversionRate,
                saleCost: saleCost,
                profit: profit,
                roi: roi
            };
            
            state.analyses.unshift(analysis);
            saveData();
            renderHistory();
        }
        
        // Рендер истории анализов
        function renderHistory() {
            if (state.analyses.length === 0) {
                elements.noHistoryMessage.classList.remove('hidden');
                elements.historyContainer.innerHTML = '';
            } else {
                elements.noHistoryMessage.classList.add('hidden');
                
                let historyHTML = '';
                state.analyses.forEach(analysis => {
                    const date = new Date(analysis.date);
                    const dateString = date.toLocaleDateString('ru-RU', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const formatter = new Intl.NumberFormat('ru-RU', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    const percentFormatter = new Intl.NumberFormat('ru-RU', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    historyHTML += `
                        <div class="history-item bg-white p-4 rounded-lg mb-3 fade-in">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-semibold text-gray-800">${analysis.campaignName}</div>
                                    <div class="text-sm text-gray-500 mt-1">Неделя: ${analysis.campaignWeek}</div>
                                    <div class="text-sm text-gray-500 mt-1">Расход: ${formatter.format(analysis.expenses)} ₽ | Лиды: ${analysis.leads}</div>
                                    <div class="text-sm text-gray-500 mt-1">Продажи: ${analysis.sales} | Доход: ${formatter.format(analysis.income)} ₽</div>
                                    <div class="text-sm text-gray-500 mt-1">Прибыль: ${formatter.format(analysis.profit)} ₽ | ROI: ${percentFormatter.format(analysis.roi)}%</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-500">${dateString}</div>
                                    <button class="delete-analysis text-red-400 hover:text-red-600 mt-1" data-id="${analysis.id}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                elements.historyContainer.innerHTML = historyHTML;
                
                // Добавляем обработчики для кнопок удаления
                document.querySelectorAll('.delete-analysis').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const analysisId = parseInt(this.getAttribute('data-id'));
                        deleteAnalysis(analysisId);
                    });
                });
            }
        }
        
        // Удаление анализа из истории
        function deleteAnalysis(id) {
            state.analyses = state.analyses.filter(a => a.id !== id);
            saveData();
            renderHistory();
        }
        
        // Очистка истории
        function clearHistory() {
            if (confirm('Вы уверены, что хотите очистить всю историю анализов? Это действие нельзя отменить.')) {
                state.analyses = [];
                saveData();
                renderHistory();
            }
        }
        
        // Копирование результата в буфер обмена
        function copyResultToClipboard() {
            const leadPrice = elements.leadPriceResult.textContent;
            const conversionRate = elements.conversionRateResult.textContent;
            const saleCost = elements.saleCostResult.textContent;
            const profit = elements.profitResult.textContent;
            const roi = elements.roiResult.textContent;
            
            const resultText = `Анализ кампании: ${elements.campaignName.value} (${elements.campaignWeek.value})
Цена лида: ${leadPrice}
Конверсия в продажу: ${conversionRate}
Стоимость продажи: ${saleCost}
Прибыль: ${profit}
ROI: ${roi}`;
            
            navigator.clipboard.writeText(resultText).then(() => {
                // Временно меняем текст кнопки
                const originalText = elements.copyResultBtn.innerHTML;
                elements.copyResultBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Скопировано!';
                
                setTimeout(() => {
                    elements.copyResultBtn.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Ошибка копирования: ', err);
                alert('Не удалось скопировать результат');
            });
        }
        
        // Настройка обработчиков событий
        function setupEventListeners() {
            // Анализ кампании
            elements.calculateBtn.addEventListener('click', analyzeCampaign);
            
            // Расчет по нажатию Enter в любом поле
            const inputFields = [
                elements.campaignName,
                elements.expensesInput,
                elements.leadsInput,
                elements.goodLeadsPercent,
                elements.salesInput,
                elements.incomeInput
            ];
            
            inputFields.forEach(field => {
                field.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        analyzeCampaign();
                    }
                });
            });
            
            // Копирование результата
            elements.copyResultBtn.addEventListener('click', copyResultToClipboard);
            
            // Очистка истории
            elements.clearHistoryBtn.addEventListener('click', clearHistory);
        }
        
        // Инициализация приложения при загрузке страницы
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
